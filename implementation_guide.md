# Руководство по внедрению улучшений дашборда KPI

## Обзор изменений

В рамках доработки были созданы/изменены следующие документы:

1. **dashboard_module_improved** - полностью переработанный модуль формы дашборда
2. **improvements_summary.md** - детальное описание всех внесенных изменений
3. **skd_settings_update.xml** - дополнительные варианты настроек для СКД схем

## Пошаговая инструкция по внедрению

### Шаг 1: Обновление модуля формы

1. Откройте форму `ФормаДашборда` обработки `ДКП_ДашбордKPI` в конфигураторе
2. Перейдите в модуль формы
3. Полностью замените содержимое модуля на код из документа **dashboard_module_improved**
4. Сохраните изменения

### Шаг 2: Добавление команд на форму

В разметке формы добавьте две новые команды в командную панель:

```xml
<Commands>
    <Command name="Обновить" id="1">
        <!-- существующая команда -->
    </Command>
    
    <!-- Новые команды -->
    <Command name="СравнитьСПрошлымПериодом" id="2">
        <Title>
            <v8:item>
                <v8:lang>ru</v8:lang>
                <v8:content>Сравнить с прошлым периодом</v8:content>
            </v8:item>
        </Title>
        <ToolTip>
            <v8:item>
                <v8:lang>ru</v8:lang>
                <v8:content>Сравнить показатели с аналогичным периодом прошлого года</v8:content>
            </v8:item>
        </ToolTip>
        <Action>СравнитьСПрошлымПериодом</Action>
    </Command>
    
    <Command name="ЭкспортВExcel" id="3">
        <Title>
            <v8:item>
                <v8:lang>ru</v8:lang>
                <v8:content>Экспорт</v8:content>
            </v8:item>
        </Title>
        <ToolTip>
            <v8:item>
                <v8:lang>ru</v8:lang>
                <v8:content>Экспортировать данные в Excel, PDF или HTML</v8:content>
            </v8:item>
        </ToolTip>
        <Action>ЭкспортВExcel</Action>
        <Picture>
            <xr:Ref>StdPicture.SaveFile</xr:Ref>
            <xr:LoadTransparent>true</xr:LoadTransparent>
        </Picture>
    </Command>
</Commands>
```

### Шаг 3: Обновление схем компоновки данных

Для каждой схемы компоновки данных добавьте служебные варианты настроек:

1. **СКД_Продажи**:
   - Добавьте вариант "РасчетИтогов" из документа **skd_settings_update.xml**

2. **СКД_Прибыльность**:
   - Добавьте вариант "РасчетРентабельности" из документа **skd_settings_update.xml**

3. **СКД_Взаиморасчеты** и **СКД_Запасы**:
   - Убедитесь, что в основном варианте настроек правильно настроены totalField

### Шаг 4: Проверка итоговых полей в СКД

Для каждой схемы компоновки данных проверьте наличие итоговых полей:

```xml
<totalField>
    <dataPath>Выручка</dataPath>
    <expression>Сумма(Выручка)</expression>
</totalField>
<totalField>
    <dataPath>КоличествоПродаж</dataPath>
    <expression>Количество(РАЗЛИЧНЫЕ Документ)</expression>
    <group>Документ</group>
</totalField>
<!-- и так далее для всех KPI -->
```

### Шаг 5: Тестирование

1. **Проверка основного функционала**:
   - Откройте дашборд в режиме предприятия
   - Проверьте корректность отображения всех индикаторов
   - Убедитесь, что фильтры работают правильно

2. **Проверка новых функций**:
   - Протестируйте экспорт данных из различных таблиц
   - Проверьте функцию сравнения с прошлым периодом (базовый функционал)

3. **Проверка производительности**:
   - Сравните скорость загрузки до и после изменений
   - Унифицированный подход через СКД должен работать быстрее

### Шаг 6: Создание формы детализированного отчета (опционально)

Если еще не создана форма `ФормаДетализированногоОтчета`, создайте простую форму с:
- Полем табличного документа для отображения детализации
- Реквизитами для всех параметров фильтрации

## Ключевые изменения в архитектуре

### Было:
```
Обновление KPI → Прямые SQL запросы → Ручной разбор результатов → Обновление индикаторов
```

### Стало:
```
Обновление KPI → Выполнение СКД → API получения итогов → Унифицированное обновление индикаторов
```

## Преимущества новой архитектуры

1. **Единообразие**: Все KPI рассчитываются одинаково
2. **Производительность**: СКД оптимизирует запросы автоматически
3. **Поддержка**: Изменения в расчетах делаются в одном месте
4. **Расширяемость**: Легко добавлять новые KPI
5. **Надежность**: Меньше ручного кода = меньше ошибок

## Возможные проблемы и решения

### Проблема: Итоговые значения не отображаются
**Решение**: Проверьте, что в СКД схемах правильно настроены totalField и выбранные поля

### Проблема: Ошибка при экспорте
**Решение**: Убедитесь, что у пользователя есть права на сохранение файлов

### Проблема: Медленная работа после изменений
**Решение**: Проверьте индексы в базе данных и оптимизацию запросов в СКД

## Дальнейшие шаги

1. Доработать визуализацию сравнения периодов
2. Добавить кнопки команд на форму
3. Реализовать сохранение пользовательских настроек
4. Добавить автоматическое обновление по таймеру

## Контакты для поддержки

При возникновении вопросов по внедрению обращайтесь к разработчику или оставьте комментарий в системе управления задачами.