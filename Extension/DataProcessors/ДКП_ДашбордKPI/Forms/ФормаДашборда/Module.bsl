//==============================================================================
// МОДУЛЬ ФОРМЫ ДАШБОРДА (ФИНАЛЬНАЯ ВЕРСИЯ)
//==============================================================================

//==============================================================================
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ
//==============================================================================

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Инициализация реквизитов формы при создании на сервере
	РежимСравненияПериодов = Ложь;
	ПолноЭкран = Ложь;
	АвтоОбновлениеФильтров = Истина;

	// Установка периода по умолчанию
	БыстрыйПериод = "МесяцТекущий";
	УстановитьПериодПоШаблонуНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	// Запускаем первую загрузку данных с небольшой задержкой
	ПодключитьОбработчикОжидания("ПерваяЗагрузка", 0.5, Истина);
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	// Корректно завершаем фоновое задание, если оно еще работает
	ОтключитьОбработчикОжидания("ПроверкаФоновогоЗадания");
	ОтменитьФоновоеЗаданиеНаСервере();
КонецПроцедуры

//==============================================================================
// ОБНОВЛЕНИЕ ДАННЫХ (КЛИЕНТ-СЕРВЕРНОЕ ВЗАИМОДЕЙСТВИЕ)
//==============================================================================

&НаКлиенте
Процедура ОбновитьДанные()
	Если НачалоПериода = Неопределено ИЛИ КонецПериода = Неопределено Тогда
		ПоказатьПредупреждение(, "Заполните период анализа");
		Возврат;
	КонецЕсли;

	Элементы.ГруппаИндикаторЗагрузки.Видимость = Истина;
	ЗапуститьОбновлениеДанныхНаСервере();
	ПодключитьОбработчикОжидания("ПроверкаФоновогоЗадания", 1, Истина);
КонецПроцедуры

&НаСервере
Процедура ЗапуститьОбновлениеДанныхНаСервере()
	ПараметрыФоновогоЗадания = Новый Структура;
	ПараметрыФоновогоЗадания.Вставить("НачалоПериода", НачалоПериода);
	ПараметрыФоновогоЗадания.Вставить("КонецПериода", КонецПериода);
	ПараметрыФоновогоЗадания.Вставить("Организация", Организация);
	ПараметрыФоновогоЗадания.Вставить("Контрагент", Контрагент);
	ПараметрыФоновогоЗадания.Вставить("Менеджер", Менеджер);
	ПараметрыФоновогоЗадания.Вставить("РежимСравнения", РежимСравненияПериодов);

	РезультатВыполнения = ДлительныеОперации.ВыполнитьВФоне("ДКП_ОбщийМодуль.ПолучитьДанныеДашборда", ПараметрыФоновогоЗадания);
	ИдентификаторФонЗадания = РезультатВыполнения.ИдентификаторЗадания;
	ДанныеДашбордаАдрес = РезультатВыполнения.АдресРезультата;
КонецПроцедуры

&НаКлиенте
Процедура ПроверкаФоновогоЗадания()
	Если Не ЗначениеЗаполнено(ИдентификаторФонЗадания) Тогда
		Возврат;
	КонецЕсли;

	Состояние = ДлительныеОперацииКлиент.СостояниеЗадания(ИдентификаторФонЗадания);

	Если Состояние.Статус = "Выполняется" Тогда
		Возврат; // Ждем дальше
	КонецЕсли;

	ОтключитьОбработчикОжидания("ПроверкаФоновогоЗадания");
	Элементы.ГруппаИндикаторЗагрузки.Видимость = Ложь;

	Если Состояние.Статус = "Выполнено" Тогда
		Результат = ПолучитьИзВременногоХранилища(ДанныеДашбордаАдрес);
		ОбработатьРезультат(Результат);
	Иначе
		ПоказатьПредупреждение(, "Фоновое задание завершилось с ошибкой или было отменено.");
	КонецЕсли;
	
	ИдентификаторФонЗадания = "";
	ДанныеДашбордаАдрес = "";
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьРезультат(Результат)
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;

	Если ТипЗнч(Результат) = Тип("Структура") И Результат.Свойство("ОшибкиВыполнения") И Результат.ОшибкиВыполнения.Количество() > 0 Тогда
		ТекстОшибки = "При получении данных произошли ошибки:" + Символы.ПС + Результат.ОшибкиВыполнения[0];
		ПоказатьПредупреждение(, ТекстОшибки);
	Иначе
		ОтобразитьДанные(Результат);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ОтобразитьДанные(ДанныеДашборда)
	Если ДанныеДашборда = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ДанныеДашборда.Свойство("Продажи") Тогда
		// Здесь будет ваш код для заполнения элементов формы
		// Например: Элементы.ИндикаторВыручка.Заголовок = Формат(ДанныеДашборда.Продажи.Выручка, "ЧДЦ=2; ЧРГ=' '");
	КонецЕсли;
КонецПроцедуры


//==============================================================================
// ОБРАБОТЧИКИ ЭЛЕМЕНТОВ УПРАВЛЕНИЯ
//==============================================================================

&НаКлиенте
Процедура ПерваяЗагрузка()
	ОтключитьОбработчикОжидания("ПерваяЗагрузка");
	ОбновитьДанные();
КонецПроцедуры

&НаКлиенте
Процедура БыстрыйПериодПриИзменении(Элемент)
	УстановитьПериодПоШаблону();
	Если АвтоОбновлениеФильтров Тогда
		ОбновитьДанные();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура НачалоПериодаПриИзменении(Элемент)
	БыстрыйПериод = "";
	Если НачалоПериода > КонецПериода Тогда
		НачалоПериода = КонецПериода;
	КонецЕсли;
	Если АвтоОбновлениеФильтров Тогда
		ОбновитьДанные();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура КонецПериодаПриИзменении(Элемент)
	БыстрыйПериод = "";
	Если НачалоПериода > КонецПериода Тогда
		КонецПериода = НачалоПериода;
	КонецЕсли;
	Если АвтоОбновлениеФильтров Тогда
		ОбновитьДанные();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Обновить(Команда)
	ОбновитьДанные();
КонецПроцедуры

&НаКлиенте
Процедура СравнитьСПрошлымПериодом(Команда)
	РежимСравненияПериодов = Не РежимСравненияПериодов;
	ОбновитьДанные();
КонецПроцедуры

&НаКлиенте
Процедура ПолноЭкранныйРежим(Команда)
	ПолноЭкран = Не ПолноЭкран;
	Элементы.КоманднаяПанель.Видимость = Не ПолноЭкран;
	Элементы.ГруппаФильтры.Видимость = Не ПолноЭкран;
	Элементы.КнопкаВыходИзПолноэкранногоРежима.Видимость = ПолноЭкран;
КонецПроцедуры

//==============================================================================
// ВСПОМОГАТЕЛЬНЫЕ ПРОЦЕДУРЫ
//==============================================================================

&НаКлиенте
Процедура УстановитьПериодПоШаблону()
	УстановитьПериодПоШаблонуНаСервере();
КонецПроцедуры

&НаСервере
Процедура УстановитьПериодПоШаблонуНаСервере()
	ДатаСеанс = ТекущаяДатаСеанса();

	Если БыстрыйПериод = "Сегодня" Тогда
		НачалоПериода = НачалоДня(ДатаСеанс);
		КонецПериода = КонецДня(ДатаСеанс);
	ИначеЕсли БыстрыйПериод = "Вчера" Тогда
		НачалоПериода = НачалоДня(ДатаСеанс - 86400);
		КонецПериода = КонецДня(ДатаСеанс - 86400);
	ИначеЕсли БыстрыйПериод = "НеделяТекущая" Тогда
		НачалоПериода = НачалоНедели(ДатаСеанс);
		КонецПериода = КонецДня(ДатаСеанс);
	ИначеЕсли БыстрыйПериод = "НеделяПрошлая" Тогда
		НачалоПериода = НачалоНедели(ДатаСеанс - 604800);
		КонецПериода = КонецНедели(ДатаСеанс - 604800);
	ИначеЕсли БыстрыйПериод = "МесяцТекущий" Тогда
		НачалоПериода = НачалоМесяца(ДатаСеанс);
		КонецПериода = КонецДня(ДатаСеанс);
	ИначеЕсли БыстрыйПериод = "МесяцПрошлый" Тогда
		ПрошлыйМесяц = ДобавитьМесяц(ДатаСеанс, -1);
		НачалоПериода = НачалоМесяца(ПрошлыйМесяц);
		КонецПериода = КонецМесяца(ПрошлыйМесяц);
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ОтменитьФоновоеЗаданиеНаСервере()
	Если ЗначениеЗаполнено(ИдентификаторФонЗадания) Тогда
		Попытка
			ДлительныеОперации.ОтменитьВыполнениеЗадания(ИдентификаторФонЗадания);
		Исключение
			// Подавляем ошибку
		КонецПопытки;
	КонецЕсли;
КонецПроцедуры